name: PR Check - Supabase Secrets

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    env:
      REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
      REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Check for required secrets
        id: check
        run: |
          missing=()
          if [ -z "$REACT_APP_SUPABASE_URL" ]; then missing+=(REACT_APP_SUPABASE_URL); fi
          if [ -z "$REACT_APP_SUPABASE_ANON_KEY" ]; then missing+=(REACT_APP_SUPABASE_ANON_KEY); fi
          # service role key is optional for many PRs; list if missing
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then echo "SUPABASE_SERVICE_ROLE_KEY missing"; fi
          if [ ${#missing[@]} -gt 0 ]; then echo "missing=${missing[*]}" >> $GITHUB_OUTPUT; fi
      - name: Comment if missing
        if: steps.check.outputs.missing != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const missing = process.env.MISSING.split(' ')
            const body = `⚠️ The repository is missing the following secrets required for deployment:\n\n${missing.map(s=>`- ${s}`).join('\n')}\n\nPlease add them in Settings → Secrets and Variables → Actions.`
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            })
        env:
          MISSING: ${{ steps.check.outputs.missing }}
